<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="components/loader.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="keys.js"></script>
    <script>
      // トランプ用変数（定数）
      var c_1 = 0;       var h_1 = 1;      var d_1 = 2;       var s_1 = 3;
      var c_2 = 4;       var h_2 = 5;      var d_2 = 6;       var s_2 = 7;
      var c_3 = 8;       var h_3 = 9;      var d_3 = 10;      var s_3 = 11;
      var c_4 = 12;      var h_4 = 13;     var d_4 = 14;      var s_4 = 15;
      var c_5 = 16;      var h_5 = 17;     var d_5 = 18;      var s_5 = 19;
      var c_6 = 20;      var h_6 = 21;     var d_6 = 22;      var s_6 = 23;
      var c_7 = 24;      var h_7 = 25;     var d_7 = 26;      var s_7 = 27;
      var c_8 = 28;      var h_8 = 29;     var d_8 = 30;      var s_8 = 31;
      var c_9 = 32;      var h_9 = 33;     var d_9 = 34;      var s_9 = 35;
      var c_10 = 36;     var h_10 = 37;    var d_10 = 38;     var s_10 = 39;
      var c_J = 40;      var h_J = 41;     var d_J = 42;      var s_J = 43;
      var c_Q = 44;      var h_Q = 45;     var d_Q = 46;      var s_Q = 47;
      var c_K = 48;      var h_K = 49;     var d_K = 50;      var s_K = 51;
      // ハンド表示用配列
      var hand_text = ["♧1","♡1","♢1","♤1","♧2","♡2","♢2","♤2",
                       "♧3","♡3","♢3","♤3","♧4","♡4","♢4","♤4",
                       "♧5","♡5","♢5","♤5","♧6","♡6","♢6","♤6",
                       "♧7","♡7","♢7","♤7","♧8","♡8","♢8","♤8",
                       "♧9","♡9","♢9","♤9","♧10","♡10","♢10","♤10",
                       "♧J","♡J","♢J","♤J","♧Q","♡Q","♢Q","♤Q",
                       "♧K","♡K" "♢K","♤K",];
      // 勝敗判定用変数（定数）
      var judge_win=0;
      var judge_draw=1;
      var judge_loose=2;
      // 勝敗判定表
      var judge = [
        [judge_draw, judge_win, judge_loose],
        [judge_loose, judge_draw, judge_win],
        [judge_win, judge_loose, judge_draw],
      ];
      // 勝敗結果表示用配列
      var judge_text = ["勝ち", "あいこ", "負け"];

      // 連勝数記録
      var win_num = 0;

      // にふくら用おまじない
      var ncmb = new NCMB(appKey, clientKey);
      var JankenScore = ncmb.DataStore("JankenScore");
      var key = "score";

      // ハイスコア
      var high_score = 0;

      function gu() {
        janken(hand_gu);
      }

      function choki() {
        janken(hand_choki);
      }

      function pa() {
        janken(hand_pa);
      }

      function janken(player_hand){
        // コンピュータの手を決定
        comp_hand = Math.floor(Math.random() * 3);
        // 勝敗判定
        result = judge[player_hand][comp_hand];
        // 結果表示
        msg="player:"+hand_text[player_hand]+"<br>"+
            "comp:"+hand_text[comp_hand]+"<br>"+
            "結果:" + judge_text[result];
        $("#result").html(msg);
        // 勝敗ごとの処理
        if(result == judge_win) {
          win_num++;
          $("#result2").html(win_num + "連勝!")
        } else {
          gameover();
        }
      }

      function newgame() {
        // ハイスコア表示
        JankenScore.order(key, true).fetch()
        .then(function(result){
          high_score = result.get(key);
          $("#highscore").html("ハイスコア：" + high_score + "連勝");
        })
        .catch(function(error){
          $("#highscore").html("ハイスコア：" + high_score + "連勝");
        });
  
        win_num = 0;
        // ハンドボタン表示
        $(".hand").css("display", "inline");
        // ニューゲームボタン非表示
        $("#newgame").css("display", "none");
        $("#result").html("じゃんけん・・・ぽん")
        $("#result2").html("");
      }

      function gameover() {
        var msg = "GAME OVER<br>";
        if(win_num>0) {
          JankenScore.order(key, true).fetch()
          .then(function(result){
            high_score = result.get(key);
            if(win_num > high_score) {
              $("#result").html("ハイスコア更新!");
            }
          })
          .catch(function(error){
          });

          // スコア記録
          db = new JankenScore();
          db.set(key, win_num).save();

          msg += win_num +  "連勝でした。<br>";
        } else {
          msg += "1回も勝てませんでした。<br>次は頑張ろう";
        }
        $("#result2").html(msg);
        // ハンドボタン非表示
        $(".hand").css("display", "none");
        // ニューゲームボタン表示
        $("#newgame").css("display", "inline");
      }

      // ゲーム初期化
      $(function(){
        newgame();
      })
    </script>
</head>
<body>
  <h1 class="text-white bg-primary">じゃんけん 連勝チャレンジ！</h1>
  <div id="highscore" class="text-white bg-secondary"></div>
  <div class="mx-auto" style="width: 200px">
    <a onclick="gu();" class="btn btn-outline-primary hand" role="button">ぐー</a>
    <a onclick="choki();" class="btn btn-outline-primary hand" role="button">ちょき</a>
    <a onclick="pa();" class="btn btn-outline-primary hand" role="button">ぱー</a>
    <a onclick="newgame();" class="btn btn-info text-white" id="newgame" role="button">New Game</a>
  </div>
  <div id="result" class="text-white bg-secondary">
  </div>
  <div id="result2" class="bg-warning">
  </div>
</body>
</html>
